# 專案：AI策略交易平台 - 開發狀態

> **狀態：** ✅ 穩定 / Client-Server v2.1
> **架構：** Client-Server（React 19 + FastAPI + SQLite）

---

## 1. 技術架構（Client-Server）

本專案採用前後端分離架構，後端提供資料持久化與系統設定管理。

*   **執行環境：** 瀏覽器（前端） + Python API 伺服器（後端）。
*   **前端框架：** React 19 + TypeScript（ES Modules）。
*   **Python 執行：** **Pyodide（WebAssembly）** 於瀏覽器端執行策略與強化學習。
*   **後端 API：** FastAPI 提供策略、歷史行情與系統設定的存取。
*   **資料庫：** **SQLite**（伺服器端持久化）。
*   **AI 整合：** Ollama（透過後端代理呼叫本機模型）。
*   **設定管理：** 統一使用 `config/app.config.json`，不使用環境變數。

---

## 2. 功能實作狀態

### ✅ 核心交易引擎（Web Worker）
*   [x] **策略執行：** Python `on_tick` 迴圈在 Worker 中執行避免 UI 卡頓。
*   [x] **策略寫法：** 支援函式式 `on_tick(candles, ctx)` 與類別式策略並存。
*   [x] **策略註解：** 內建策略補上繁體中文註解並同步到資料庫。
*   [x] **沙盒隔離：** `StrategyContext` 將使用者策略與主執行緒隔離。
*   [x] **策略重載：** Pyodide 重新定義同名函式/類別時可辨識變更，避免沿用舊策略。
*   [x] **函式庫：** `numpy`、`pandas` 已預載。
*   [x] **成本模型：** 可配置滑價、交易稅、手續費。
*   [x] **策略庫：** 策略改由後端資料庫管理，空白帳號會自動灌入內建策略種子。
*   [x] **Level 2 支援：** 策略可讀取 5 檔委買賣資料。
*   [x] **行情介面：** 定義行情資料介面規格，提供模擬即時行情模組。

### ✅ 資料管理（後端持久化）
*   [x] **伺服器資料庫：** SQLite 儲存策略、歷史行情與系統設定。
*   [x] **持久化：** 資料可跨重啟保存。
*   [x] **模擬資料：** 內建多種行情模擬與 Level 2 生成。
*   [x] **行情資料模型：** 新增 symbol/frequency/timezone/exchange 欄位並完成遷移。
*   [x] **行情權限與品質：** 行情 API 需授權，並加入基本 OHLC/成交量合理性檢查。

### ✅ 儀表板與 UI
*   [x] **小工具系統：** 拖拉、縮放、最大化布局。
*   [x] **圖表與視覺化：** K 線、成交量、權益曲線、Order Flow 熱力圖。
*   [x] **回測控制：** 已整合至策略管理卡片（成本參數與 Walk-Forward 設定）。
*   [x] **資料管理：** 已獨立為資料管理卡片。
*   [x] **UX 改善：** 即時提示與專業版面配置。
*   [x] **視窗互動：** 點選視窗自動置頂顯示。
*   [x] **行情範圍：** 支援切換商品/頻率/時區/交易所範圍。
*   [x] **行情狀態：** 顯示狀態與時間戳。
*   [x] **WFO 切換：** 策略管理可勾選 WFO 模式回測。
*   [x] **行情範圍設定：** 可保存並自動載入。
*   [x] **當沖模式：** 策略管理可開啟或關閉當沖模式。
*   [x] **策略新增：** 支援 AI 生成與手動新增策略。
*   [x] **程式碼編輯：** 程式碼視窗可直接編輯策略並自動保存。
*   [x] **策略說明：** 策略管理改為彈窗查看說明。
*   [x] **程式碼預覽：** 程式碼視窗提供同步語法高亮與手動保存。
*   [x] **佈局管理：** 明確的佈局存檔與還原預設按鈕。
*   [x] **預設佈局：** 已同步為目前存檔的佈局與尺寸。
*   [x] **策略管理：** 改為下拉式選單切換策略。
*   [x] **策略種子：** 支援一鍵重建內建策略（後端自動灌入）。
*   [x] **模式介面：** 依模式隱藏非必要操作（回測/RL/AI）。
*   [x] **行情來源：** 提供行情來源選擇與模擬行情啟動控制。
*   [x] **自由佈局：** 卡片支援自由拖曳與縮放，預設配置依模式優先主題相關內容。
*   [x] **回測效能：** 支援最大回溯視窗限制以縮短回測耗時。
*   [x] **回測區間：** 可獨立指定回測日期範圍。
*   [x] **當沖模式：** 支援強制指定時間平倉或僅阻擋再進場。
*   [x] **載入天數：** 可設定 K 線載入天數上限。
*   [x] **行情控制：** K 線圖左上顯示載入天數並提供手動載入，往回/往前常駐可見。
*   [x] **文件補齊：** 策略開發說明（人類/AI）。
*   [x] **回測實驗室：** 回測功能獨立視窗，回測績效/權益/交易明細與啟動策略分離。
*   [x] **回測區間設定：** 已移至回測實驗室集中管理。
*   [x] **回測當沖設定：** 回測實驗室可獨立設定是否當沖。
*   [x] **行情標題：** K 線標題顯示使用中策略名稱，績效/權益/交易明細依載入天數更新。
*   [x] **回測最佳化：** 回測實驗室可設定最佳化搜尋方法與目標。
*   [x] **回測狀態提示：** 策略回測進行中會在 K 線標題提示。
*   [x] **最佳化設定介面：** 策略管理的最佳化設定改為英文顯示並支援更多目標。
*   [x] **策略新增入口：** 新增策略與 AI 生成策略移至回測實驗室。
*   [x] **實驗室入口：** DQN/程式碼/AI 自動進化由回測實驗室開啟並以實驗室策略為準。
*   [x] **DQN 視窗：** 固定在 RL 模式開啟並可調整尺寸。
*   [x] **程式碼視窗：** 從回測實驗室開啟不切換模式，標題顯示策略名稱。
*   [x] **AI 進化：** 從回測實驗室開啟不切換模式，保留回測實驗室視窗。
*   [x] **AI 進化指令：** 改為回測實驗室內輸入指令，不再開獨立視窗。
*   [x] **DQN 開啟方式：** 從回測實驗室開啟不切換模式，保留其他視窗。
*   [x] **DQN 視窗互動：** 在非 RL 模式開啟仍可拖曳與縮放。
*   [x] **Dock 精簡：** DQN/程式碼/AI 進化改由回測實驗室開啟，Dock 不再顯示。
*   [x] **Dock 位置：** Dock 最小化固定左上角，開始按鈕固定不位移，展開以垂直清單覆蓋顯示。
*   [x] **Dock 收合：** 點擊 Dock 以外區域自動收合。
*   [x] **下單撮合：** 策略支援限價下單與刪單，close_all 以可即時成交的限價方式撮合。
*   [x] **回測當沖規則：** 回測實驗室可設定當沖規則與強制平倉時間。
*   [x] **內建策略更新：** 內建策略改用限價下單介面與新參數寫法。
*   [x] **回測實驗室一致性：** 策略切換後的績效/權益/明細依回測區間重新計算。
*   [x] **回測實驗室參數：** 回測實驗室提供策略參數設定。
*   [x] **回測策略快照：** 回測時改用選定策略快照，避免切換後結果混用。
*   [x] **回測參數彈窗：** 回測實驗室的參數設定改為彈窗操作。
*   [x] **回測實驗室回測觸發：** 直接使用當前選取策略，不依賴狀態切換。
*   [x] **最佳化提示：** 回測開啟最佳化後，結束時以按鈕選擇更新/不更新策略參數。

### ✅ AI 實驗室與最佳化
*   [x] **Ollama 整合：** 生成與改寫策略（繁體中文輸出）。
*   [x] **自動進化：** 依回測結果調整策略邏輯。
*   [x] **參數優化：** Grid / Random Search。

### ✅ 強化學習（RL）
*   [x] **DQN 架構：** 使用 Micro-MLP + Experience Replay。
*   [x] **策略輸出：** 訓練完成可輸出推論策略。
*   [x] **自訂環境：** AI 可生成環境與特徵工程。

---

## 3. 已知限制與未來工作

1. **市場資料來源：** 目前僅為模擬資料，未接真實行情。
2. **效能限制：** 大量歷史資料會增加瀏覽器負載。
3. **行動裝置支援：** UI 主要針對桌面與平板設計。
4. **資料治理：** 需補齊資料結構、時區/頻率/日曆規範與品質檢查。
5. **回測風控：** 需落實交易成本、滑價與風控規則，並輸出完整績效指標。
6. **可觀測性：** 長任務進度、錯誤率與延遲監控尚未完善。
7. **權限控管：** 基礎多使用者已完成，細緻 RBAC/審計待補。

---

## 4. 進化方案（分階段）

### 4.1 資料與設定基座
*   [x] 統一行情資料模型與欄位規範（時間/資產/時區/頻率）。
*   [ ] 建立資料品質檢查與修正紀錄。
*   [x] 補齊設定檔的資料治理欄位並驗證。

### 4.2 研究/回測核心
*   [ ] 回測引擎支援交易成本、滑價與風控規則。
*   [x] 輸出統一績效摘要（年化、波動、Sharpe/Sortino、最大回撤、Turnover）。
*   [x] 回測結果可追溯指紋（策略碼雜湊/資料指紋/隨機種子）。
*   [x] 回測摘要 API 與前端列表。

### 4.3 策略與執行準備
*   [ ] 建立訊號→部位→風控→模擬下單流程。
*   [ ] 支援多資產與曝險分散限制。
*   [ ] 提供基準策略與對照組（Buy & Hold、等權重）。
*   [x] 單策略啟用時自動產生回測交易標記。

### 4.4 監控與可觀測
*   [ ] 建立任務狀態、錯誤與延遲監控。
*   [ ] 長任務可追蹤進度並輸出摘要報告。
*   [ ] 支援中斷復原與結果回溯。
*   [x] 任務逾時與狀態一致性處理。

### 4.5 多使用者與權限
*   [x] 基礎帳號註冊/登入與訪客模式。
*   [ ] 角色權限與審計紀錄（RBAC）。

---

## 5. 開發規範

*   **設定檔唯一來源：** `config/app.config.json`。
*   **後端資料存取：** 前端不可直接操作 SQLite。
*   **非同步執行：** 重運算需使用 `await` 或 Worker。
